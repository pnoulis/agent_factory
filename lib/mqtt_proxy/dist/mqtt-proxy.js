var V=Object.create;var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var X=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Y=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of W(e))!K.call(t,s)&&s!==n&&L(t,s,{get:()=>e[s],enumerable:!(i=H(e,s))||i.enumerable});return t};var Z=(t,e,n)=>(n=t!=null?V(_(t)):{},Y(e||!t||!t.__esModule?L(n,"default",{value:t,enumerable:!0}):n,t));var N=X((jt,M)=>{"use strict";M.exports=function(t){return typeof t=="number"?t-t===0:typeof t=="string"&&t.trim()!==""?Number.isFinite?Number.isFinite(+t):isFinite(+t):!1}});var tt={debug:(...t)=>{},trace:(...t)=>{}},q=class extends Error{constructor(t,e){super(t,{cause:e}),this.name=this.constructor.name}},a={};a.Idle=function(t){this.name="idle",this.taskRunner=t,this.getState=()=>this};a.Idle.prototype.run=function(t){return t(()=>this.taskRunner.setState(this.taskRunner.isConnected()?"connected":"pending"))};a.Pending=function(t){this.name="pending",this.taskRunner=t,this.getState=()=>this};a.Pending.prototype.init=function(){this.poll()};a.Pending.prototype.poll=function(){let t=setInterval(()=>{if(this.taskRunner.isConnected())return clearInterval(t),this.taskRunner.setState("connected");this.taskRunner.flush(),this.taskRunner.jobQueue.length===0&&(clearInterval(t),this.taskRunner.setState("idle"))},this.taskRunner.pollFrequency)};a.Pending.prototype.run=function(t){return t()};a.Connected=function(t){this.name="connected",this.taskRunner=t,this.getState=()=>this};a.Connected.prototype.init=function(){this.taskRunner.flush(),this.runJobs()};a.Connected.prototype.runJobs=function(){this.taskRunner.jobQueue.length===0?this.taskRunner.setState("idle"):this.taskRunner.isConnected()?(this.taskRunner.jobQueue.shift().exec(),this.runJobs()):this.taskRunner.setState("pending")};a.Connected.prototype.run=function(t){return t(()=>this.runJobs())};function f(t={}){let e=this.parseConf(t);this.timeout=e.timeout,this.logger=e.logger,this.isConnected=e.isConnected,this.pollFrequency=e.pollFrequency,this.jobQueue=[],this.state=null,this.states={idle:new a.Idle(this),pending:new a.Pending(this),connected:new a.Connected(this)},this.setState("idle")}f.prototype.parseConf=function(t){let e={};return e.logger=t.logger||tt,e.timeout=t.timeout||3e4,e.pollFrequency=t.pollFrequency||1e3,e.isConnected=t.isConnected?t.isConnected:()=>!1,e};f.prototype.setState=function(t){let e=`[TRANSITION]:taskRunner ${this.state?.name}`;if(this.state=this.states[t],!this.state)throw new q(`Unrecognized state: ${t}`);"init"in this.state&&this.state.init()};f.prototype.queue=function(t){return this.jobQueue.push(t)};f.prototype.flush=function(){let t=Date.now();this.jobQueue=this.jobQueue.filter(e=>(t>=e.timeout&&e.exec(!0),t<e.timeout))};f.prototype.newJob=function(t,e){return n=>new Promise((i,s)=>{e.cb?this.queue({timeout:Date.now()+(e.timeout||this.timeout),exec:r=>{if(r)t(new Error("task timeout"));else try{t()}catch(o){t(new q("Synchronous error",o))}}}):this.queue({timeout:Date.now()+(e.timeout||this.timeout),exec:r=>{if(r)s(new Error("task timeout"));else try{t().then(i,s)}catch(o){s(new q("Synchronous error",o))}}}),n&&n()})};f.prototype.inState=function(t){return t===this.state.name};f.prototype.run=function(t,e){return typeof t=="function"&&(e=t,t={}),this.state.run(this.newJob(e,t))};var et={debug:(...t)=>console.log(...t)},x=class extends Error{constructor(e,n){super(e,{cause:n}),this.name=this.constructor.name}};function h(t={}){let e=this.parseConf(t);this.strict=e.strict,this.paramSyntax=e.paramSyntax,this.params=e.params,this.routes=new Map,e.routes.forEach(n=>this.setRoute(n))}h.prototype.parseConf=function(e){e.logger&&(et=e.logger);let n={};return n.strict=e.strict??!0,n.params=new Map(Object.entries(e.params||{})),n.paramSyntax=new RegExp(e.paramSyntax||"\\${([a-zA-Z]+)}"),n.routes=e.routes||[],n};h.prototype.setRoute=function(e){if(typeof e.alias!="string"||e.alias.length<1)throw new x(`Invalid route alias: ${e.alias}`);let[n,i,s]=this.canonicalizeTopics(e.alias,e.pub,e.sub);return this.routes.set(n,{pub:i,sub:s})};h.prototype.getRoute=function(e){let n=this.routes.get(e);return n?{alias:e,...n}:void 0};h.prototype.setParam=function(e,n){if(typeof n!="string")throw new x(`Parameter value: ${n} must be a string`);return this.params.set(e,n)};h.prototype.getParam=function(e){return this.params.get(e)};h.prototype.canonicalizeTopics=function(...e){return e.map((n,i)=>(n==null||(n=n.replace(/\/{2,}/g,"/"),n.startsWith("/")||(n="/"+n),n.endsWith("/")&&(n=n.slice(0,-1)),n=n.replace(/\s/g,"")),n))};h.prototype.replaceParams=function(...e){return e.map((n,i)=>n===null?n:n.replace(/\${([a-z]+)}/gi,(s,r)=>{let o=this.getParam(r);if(!o)throw new x(`Missing parameter: ${r} for topic: ${n}`);return o}))};h.prototype.resolve=function(e,n){let[i]=this.canonicalizeTopics(e);if(!this.routes.has(i)&&(Object.hasOwn(n,"strict")?n.strict:this.strict))throw new x(`Unregistered route alias: ${i}`);let{pub:s,sub:r}=this.routes.get(i)||{pub:i,sub:i};return[s,r]=this.replaceParams(s,r),{alias:i,pub:s,sub:r}};var ot=Z(N(),1);var E,nt=new Uint8Array(16);function U(){if(!E&&(E=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(nt)}var u=[];for(let t=0;t<256;++t)u.push((t+256).toString(16).slice(1));function J(t,e=0){return u[t[e+0]]+u[t[e+1]]+u[t[e+2]]+u[t[e+3]]+"-"+u[t[e+4]]+u[t[e+5]]+"-"+u[t[e+6]]+u[t[e+7]]+"-"+u[t[e+8]]+u[t[e+9]]+"-"+u[t[e+10]]+u[t[e+11]]+u[t[e+12]]+u[t[e+13]]+u[t[e+14]]+u[t[e+15]]}var it=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),T={randomUUID:it};function st(t,e,n){if(T.randomUUID&&!e&&!t)return T.randomUUID();t=t||{};let i=t.random||(t.rng||U)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){n=n||0;for(let s=0;s<16;++s)e[n+s]=i[s];return e}return J(i)}var $=st;function g({logLevel:t="trace"}={}){this.logLevel=this.levels[t]}g.prototype.levels={trace:5,debug:4,info:3,warn:2,error:1,fatal:0,silent:-1};g.prototype.trace=function(...t){this.logLevel<this.levels.trace};g.prototype.debug=function(...t){this.logLevel<this.levels.debug};g.prototype.info=function(...t){this.logLevel<this.levels.info};g.prototype.warn=function(...t){this.logLevel<this.levels.warn};g.prototype.error=function(...t){this.logLevel<this.levels.error};g.prototype.fatal=function(...t){this.logLevel<this.levels.fatal};function ut(...t){return t.length>1?t.map(e=>e.charAt(0).toUpperCase()+e.slice(1)):t[0].charAt(0).toUpperCase()+t[0].slice(1)}function at(t){let e=[];for(let n=1;n<t.length;n+=2)e.push(t[n]);return e}function lt(t){let e=[];for(let n=0;n<t.length;n+=2)e.push(t[n]);return e}function Q(t){return t!==null&&typeof t=="object"&&Array.isArray(t)===!1}var ct=globalThis.window,zt=!ct&&globalThis.self,Dt=globalThis.process;function ht(t,e=[]){let n=t.prototype;Object.defineProperties(n,{events:{value:[...e,"error"],enumerable:!0,writable:!0},packageListener:{value:pt,enumerable:!0,writable:!1},ensureEvent:{value:ft,enumerable:!0,writable:!1},on:{value:dt,enumerable:!0,writable:!1},once:{value:bt,enumerable:!0,writable:!1},hasEvent:{value:gt,enumerable:!0,writable:!1},flush:{value:mt,enumerable:!0,writable:!1},emit:{value:yt,enumerable:!0,writable:!1}})}function pt(t,e={}){return{listener:t,persistent:e.persist??!0}}function ft(t){if(!Object.hasOwn(this.events,t)){let e=new Error(`Unrecognized event: ${t}`);throw this.emit("error",e),e}}function dt(t,e){return this.ensureEvent(t),this.events[t].push(this.packageListener(e,{persist:!0})),()=>this.flush(t,e)}function bt(t,e){return this.ensureEvent(t),this.events[t].push(this.packageListener(e,{persist:!1})),()=>this.flush(t,e)}function gt(t){return Object.hasOwn(this.events,t)}function mt(t,e,n){return/^\*$/.test(t)?Object.keys(this.events).forEach(i=>this.flush(i,e,n)):(this.ensureEvent(t),typeof e=="function"?this.events[t]=this.events[t].filter(i=>i.listener!==e):typeof e=="string"?this.events[t]=this.events[t].filter(i=>i.id!==e):typeof n=="function"?this.events[t]=this.events[t].reduce((i,s)=>n(s)?i:[...i,s],[]):this.events[t]=[],this)}function yt(t,...e){return this.ensureEvent(t),[...this.events[t]].forEach(n=>n.listener&&n.listener(...e)),this.events[t]=this.events[t].filter(({listener:n,persistent:i})=>i),this}ht.construct=function(){let t={};for(let e=0;e<this.events.length;e++)t[this.events[e]]=[];this.events=t};function C(t,e=[]){let n=t,i=t.prototype,s=at(e),r=lt(e);r.forEach((o,c)=>{Object.defineProperty(o.prototype,"name",{enumerable:!0,configurable:!0,get:function(){return s[c]}}),Object.defineProperty(o.prototype,"index",{enumerable:!0,configurable:!0,get:function(){return c}}),Object.defineProperty(i,`get${ut(s[c])}State`,{enumerable:!0,configurable:!0,get:function(){return this.states[c]}})}),Object.defineProperty(n,"states",{value:s,enumerable:!0,writable:!0,configurable:!0}),Object.defineProperties(i,{states:{value:r,enumerable:!0,writable:!0,configurable:!0},state:{value:null,enumerable:!0,configurable:!0,writable:!0},getState:{value:vt,enumerable:!0,writable:!0,configurable:!0},setState:{value:wt,enumerable:!0,writable:!0,configurable:!0},inState:{value:xt,enumerable:!0,writable:!0,configurable:!0},compareStates:{value:St,enumerable:!0,writable:!0,configurable:!0}})}function vt(t){if(t){let e=this.states.length;if(typeof t=="string"){for(let n=0;n<e;n++)if(this.states[n].name===t)return this.states[n]}else if(Q(t)){for(let n=0;n<e;n++)if(this.states[n].name===t.name)return t}throw new Error(`Unrecognized state: ${t}`)}return this.state}function wt(t){let e=this.state?.name;return typeof t=="string"&&(t=this.getState(t)),this.state=t,typeof this.emit=="function"&&Q(this.events)&&this.emit("stateChange",this.state.name,e,this),"init"in this.state&&this.state.init(),this}function xt(t){return t===this.state.name||t===this.state.index}function St(t){let e={},n=this.constructor.states.length;for(let i=0;i<n;i++)e[this.constructor.states[i]]=i;return t(e,this.state.index)}C.construct=function(){this.states=this.states.map(t=>new t(this)),this.state=this.states[0]};function G(){return $()}var Rt={debug:(...t)=>{},trace:(...t)=>{}},F=class extends Error{constructor(t,e){super(t,{cause:e}),this.name=this.constructor.name}},l={};l.Idle=function(t){this.name="idle",this.taskRunner=t,this.getState=()=>this};l.Idle.prototype.run=function(t){return t(()=>this.taskRunner.setState(this.taskRunner.isConnected()?"connected":"pending"))};l.Pending=function(t){this.name="pending",this.taskRunner=t,this.getState=()=>this};l.Pending.prototype.init=function(){this.poll()};l.Pending.prototype.poll=function(){let t=setInterval(()=>{if(this.taskRunner.isConnected())return clearInterval(t),this.taskRunner.setState("connected");this.taskRunner.flush(),this.taskRunner.jobQueue.length===0&&(clearInterval(t),this.taskRunner.setState("idle"))},this.taskRunner.pollFrequency)};l.Pending.prototype.run=function(t){return t()};l.Connected=function(t){this.name="connected",this.taskRunner=t,this.getState=()=>this};l.Connected.prototype.init=function(){this.taskRunner.flush(),this.runJobs()};l.Connected.prototype.runJobs=function(){this.taskRunner.jobQueue.length===0?this.taskRunner.setState("idle"):this.taskRunner.isConnected()?(this.taskRunner.jobQueue.shift().exec(),this.runJobs()):this.taskRunner.setState("pending")};l.Connected.prototype.run=function(t){return t(()=>this.runJobs())};function m(t={}){let e=this.parseConf(t);this.timeout=e.timeout,this.logger=e.logger,this.isConnected=e.isConnected,this.pollFrequency=e.pollFrequency,this.jobQueue=[],this.state=null,this.states={idle:new l.Idle(this),pending:new l.Pending(this),connected:new l.Connected(this)},this.setState("idle")}m.prototype.parseConf=function(t){let e={};return e.logger=t.logger||Rt,e.timeout=t.timeout||3e4,e.pollFrequency=t.pollFrequency||1e3,e.isConnected=t.isConnected?t.isConnected:()=>!1,e};m.prototype.setState=function(t){let e=`[TRANSITION]:taskRunner ${this.state?.name}`;if(this.state=this.states[t],!this.state)throw new F(`Unrecognized state: ${t}`);"init"in this.state&&this.state.init()};m.prototype.queue=function(t){return this.jobQueue.push(t)};m.prototype.flush=function(){let t=Date.now();this.jobQueue=this.jobQueue.filter(e=>(t>=e.timeout&&e.exec(!0),t<e.timeout))};m.prototype.newJob=function(t,e){return n=>new Promise((i,s)=>{e.cb?this.queue({timeout:Date.now()+(e.timeout||this.timeout),exec:r=>{if(r)t(new Error("task timeout"));else try{t()}catch(o){t(new F("Synchronous error",o))}}}):this.queue({timeout:Date.now()+(e.timeout||this.timeout),exec:r=>{if(r)s(new Error("task timeout"));else try{t().then(i,s)}catch(o){s(new F("Synchronous error",o))}}}),n&&n()})};m.prototype.inState=function(t){return t===this.state.name};m.prototype.run=function(t,e){return typeof t=="function"&&(e=t,t={}),this.state.run(this.newJob(e,t))};function S(t,e,...n){this.route=e,this.middleware=n,this.queue=null,this.nextIndex=0;let i=function(s,r){return new S(t,e,...n).exec([t.beforeAll,n.map(o=>[t.beforeEach,o,t.afterEach]),t.afterAll,t.globalLast],s,r)};return i.skipAll=function(s,r){return new S(t,e,...n).exec([this.middleware],s,r)},i.exec=this.exec.bind(this),i}S.prototype.findNextErrHandlerIndex=function(t){let e=this.queue.length;for(;t<e;t++)if(this.queue.at(t).length>2)return t;return-1};S.prototype.runner=async function(t,e,n){this.nextIndex=e;let i=this.queue.at(this.nextIndex);i&&await i(t,this.runner.bind(this,t,e+1),n)};S.prototype.exec=async function(t,e,n){this.queue=t.flat(3),this.nextIndex=0;let i=this.queue.length,s={route:this.route,args:{...e},options:{onlyData:!0,...n},req:{},res:{}},r=null;for(;this.nextIndex<i;)try{await this.runner(s,this.nextIndex,r)}catch(o){if(r=o,this.nextIndex=this.findNextErrHandlerIndex(this.nextIndex+1),this.nextIndex===-1)throw o}return this.queue=null,s?.options?.onlyData?s.res.data:(delete s.args,delete s.options,s)};var d=class{constructor(){this.beforeAll=[],this.beforeEach=[],this.afterAll=[],this.afterEach=[]}};d.prototype.globalLast=async function(t,e,n){if(n)throw n;e()};d.prototype.flush=function(){this.globalLast=null,this.beforeAll.splice(0,this.beforeAll.length),this.beforeEach.splice(0,this.beforeEach.length),this.afterAll.splice(0,this.afterAll.length),this.afterEach.splice(0,this.afterEach.length)};d.prototype.setGlobalLast=function(t){this.globalLast=t};d.prototype.setBeforeAll=function(...t){this.beforeAll.push(...t)};d.prototype.setBeforeEach=function(...t){this.beforeEach.push(...t)};d.prototype.setAfterAll=function(...t){this.afterAll.push(...t)};d.prototype.setAfterEach=function(...t){this.afterEach.push(...t)};d.prototype.route=function(t,...e){return new S(this,t,...e)};var p=class{constructor(e){this.subscription=e}publish(){}subscribe(){}};var I=class extends p{constructor(e){super(e)}publish(){this.subscription.setState(this.subscription.getConnectingState),this.subscription.connect(e=>{e?(this.subscription.setState(this.subscription.getDownState),this.subscription.setNextPublishingClient(),this.subscription.deliver(e)):this.subscription.setState(this.subscription.getDeliveringState)})}subscribe(){this.subscription.setState(this.subscription.getConnectingState),this.subscription.connect(e=>{e?(this.subscription.setState(this.subscription.getDownState),this.subscription.deliver(e)):this.subscription.setState(this.subscription.getUpState)})}};var j=class extends p{constructor(e){super(e)}};var P=class extends p{constructor(e){super(e)}publish(){this.subscription.setState(this.subscription.getDeliveringState)}};var O=class extends p{constructor(e){super(e)}init(){this.subscription.publishNextClient()}};var A=class{constructor(e){this.id=G(),this.mode=e.mode}unsubscribe(){let e=-1;for(let n=0;n<this.subscription.clients.length;n++)this.subscription.clients[n].id===this.id&&(e=n);if(e>-1)this.subscription.clients[e]?.deliver.apply(null,[!0,null]),this.subscription.clients=this.subscription.clients.slice(0,e).concat(this.subscription.clients.slice(e+1));else throw new Error(`Failed to unsubscribe missing client with id:${this.id}`)}publish(){}deliver(){}},R=class extends A{constructor(e,n){super(n),this.deliver=e}},y=class extends A{constructor(e,n,i){super(i),this.publish=e,this.deliver=n}};var k=class{constructor(e,n,i){C.construct.call(this),this.server=e,this.pub=n,this.sub=i,this.clients=[]}connect(e){let n=(i=0)=>{this.server.subscribe(this.sub,s=>{s?i<10?n(i+1):e(s):e(null)})};n()}getCurrentPublishingClient(){for(let e=0;e<this.clients.length;e++)if(this.clients[e]instanceof y)return this.clients[e]}getRecipients(){let e=null;this.publisher&&this.publisher.mode!=="ff"&&(e=this.publisher);let n=[],i=[];for(let s=0;s<this.clients.length;s++)this.clients[s]instanceof R?(n.push(this.clients[s]),this.clients[s].mode!=="response"&&i.push(this.clients[s])):i.push(this.clients[s]);return this.clients=i,{publisher:e,subs:n}}setNextPublishingClient(){let e=-1;for(let n=0;n<this.clients.length;n++)if(this.clients[n]instanceof y){e=n;break}return e>-1?(this.publisher=this.clients[e],this.clients=this.clients.slice(0,e).concat(this.clients.slice(e+1))):this.publisher=null,this.publisher}publishNextClient(){this.setNextPublishingClient(),this.publisher?this.publisher.publish(e=>e&&this.deliver(e)):this.setState(this.getUpState)}deliver(e,n){let{publisher:i,subs:s}=this.getRecipients();i&&i.deliver(!1,e,n);for(let r=0;r<s.length;r++)s[r].deliver(!1,e,n);this.publishNextClient()}publish(e){return e.subscription=this,this.clients.push(e),this.state.publish(),e}subscribe(e){return e.subscription=this,this.clients.push(e),this.state.subscribe(),e}};C(k,[I,"down",j,"connecting",P,"up",O,"delivering"]);var v=class{constructor({server:e,registry:n}){this.server=e,this.registry=new h(n),this.subscriptions=new Map,this.tr=new f({isConnected:function(){return e.connected}}),this.server.on("message",(i,s)=>{let r=this.subscriptions.get(i);if(r)try{s=this.decode(s),r.deliver(null,s)}catch(o){r.deliver(o)}})}};v.prototype.decode=function(e=""){try{return JSON.parse(e.toString())||{}}catch{throw new Error("Failed to decode message")}};v.prototype.encode=function(e=""){try{return JSON.stringify(e)}catch{throw new Error("Failed to encode message")}};v.prototype.subscribe=function(e,n,i){return this.tr.run(()=>new Promise((s,r)=>{try{let{pub:o,sub:c}=this.registry.resolve(e,i),w=this.subscriptions.get(c);w||(w=new k(this.server,o,c),this.subscriptions.set(c,w)),i={mode:"persistent",...i},/response|persistent/.test(i.mode)||r(new Error(`subscribe() does not support options.mode:${i.mode}`));let b=w.subscribe(new R(n,i));s(b.unsubscribe.bind(b))}catch(o){r(o)}}))};v.prototype.publish=function(e,n,i){return this.tr.run(()=>new Promise((s,r)=>{try{let{pub:o,sub:c}=this.registry.resolve(e,i),w=this.encode(n),b=this.subscriptions.get(c);b||(b=new k(this.server,o,c),this.subscriptions.set(c,b)),i={mode:"response",...i},/response|ff/.test(i.mode)||r(new Error(`publish() does not support options.mode:${i.mode}`)),b.publish(new y(z=>this.server.publish(o,w,z),function(z,D,B){return D?r(D):s(B)},i))}catch(o){r(o)}}))};export{v as MqttProxy};
/*! Bundled license information:

is-number/index.js:
  (*!
   * is-number <https://github.com/jonschlinkert/is-number>
   *
   * Copyright (c) 2014-present, Jon Schlinkert.
   * Released under the MIT License.
   *)
*/
