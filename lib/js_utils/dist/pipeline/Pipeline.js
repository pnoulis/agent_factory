function h(t,e,...o){this.route=e,this.middleware=o,this.queue=null,this.nextIndex=0;let n=function(s,l){return new h(t,e,...o).exec([t.beforeAll,o.map(a=>[t.beforeEach,a,t.afterEach]),t.afterAll,t.globalLast],s,l)};return n.skipAll=function(s,l){return new h(t,e,...o).exec([this.middleware],s,l)},n.exec=this.exec.bind(this),n}h.prototype.findNextErrHandlerIndex=function(t){let e=this.queue.length;for(;t<e;t++)if(this.queue.at(t).length>2)return t;return-1};h.prototype.runner=async function(t,e,o){this.nextIndex=e;let n=this.queue.at(this.nextIndex);n&&await n(t,this.runner.bind(this,t,e+1),o)};h.prototype.exec=async function(t,e,o){this.queue=t.flat(3),this.nextIndex=0;let n=this.queue.length,s={route:this.route,args:{...e},options:{onlyData:!0,...o},req:{},res:{}},l=null;for(;this.nextIndex<n;)try{await this.runner(s,this.nextIndex,l)}catch(i){if(l=i,this.nextIndex=this.findNextErrHandlerIndex(this.nextIndex+1),this.nextIndex===-1)throw i}return this.queue=null,s?.options?.onlyData?s.res.data:(delete s.args,delete s.options,s)};var r=class{constructor(){this.beforeAll=[],this.beforeEach=[],this.afterAll=[],this.afterEach=[]}};r.prototype.globalLast=async function(e,o,n){if(n)throw n;o()};r.prototype.flush=function(){this.globalLast=null,this.beforeAll.splice(0,this.beforeAll.length),this.beforeEach.splice(0,this.beforeEach.length),this.afterAll.splice(0,this.afterAll.length),this.afterEach.splice(0,this.afterEach.length)};r.prototype.setGlobalLast=function(e){this.globalLast=e};r.prototype.setBeforeAll=function(...e){this.beforeAll.push(...e)};r.prototype.setBeforeEach=function(...e){this.beforeEach.push(...e)};r.prototype.setAfterAll=function(...e){this.afterAll.push(...e)};r.prototype.setAfterEach=function(...e){this.afterEach.push(...e)};r.prototype.route=function(t,...e){return new h(this,t,...e)};export{r as Pipeline};
